name: 'SOL RPC'

on:
  pull_request:
  merge_group:
  push:
    branches:
      - main
    tags:
      - v*
    paths-ignore:
      - "README.md"
env:
  CARGO_TERM_COLOR: always
  IC_WASM_VERSION: "0.9.10"
  ICP_CLI_VERSION: "0.1.0"
  POCKET_IC_VERSION: "12.0.0"
  SOLANA_CLI_VERSION: "2.1.15"
  RUSTFLAGS: "-Dwarnings"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Check code'
        run: |
          cargo fmt --all -- --check
          cargo clippy --locked --verbose --tests --benches --workspace -- -D clippy::all
          cargo clippy --locked --verbose --target wasm32-unknown-unknown -p sol_rpc_canister -- -D clippy::all

      - name: 'Install cargo-sort'
        run: cargo install cargo-sort

      - name: 'Check Cargo.toml'
        run: cargo sort --workspace --check

  check-cargo-lock:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Check root Cargo.lock is up to date'
        run: |
          cargo check --workspace --locked || {
            echo "❌ Root Cargo.lock is out of date"
            echo "Run 'cargo check' in the root directory and commit the updated 'Cargo.lock'"
            exit 1
          }

      - name: 'Check ninja Cargo.lock is up to date'
        working-directory: examples/basic_solana/ninja
        run: |
          cargo check --locked || {
            echo "❌ Ninja Cargo.lock is out of date" 
            echo "Run 'cargo check' in 'examples/basic_solana/ninja/' and commit the updated 'Cargo.lock'"
            exit 1
          }

  cargo-doc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Cargo doc
        run: |
          cargo doc --workspace --no-deps
        env:
          RUSTDOCFLAGS: "--deny warnings"

  reproducible-build:
    runs-on: ubuntu-22.04
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Docker build'
        run: |
          ./scripts/docker-build

      - name: 'Archive artifact'
        uses: actions/upload-artifact@v4
        with:
          name: sol_rpc_canister.wasm.gz
          path: ./wasms/sol_rpc_canister.wasm.gz
          if-no-files-found: error
          compression-level: 0

      - name: 'Add summary'
        run: |
          hash=`sha256sum ./wasms/sol_rpc_canister.wasm.gz`
          echo "SHA-256 :hash: ${hash}" >> $GITHUB_STEP_SUMMARY

  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
      - name: 'Run unit tests'
        run: cargo test --locked --workspace --exclude basic_solana --exclude sol_rpc_int_tests --exclude sol_rpc_e2e_tests

  basic-solana-ninja-deployment:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Install dfx'
        uses: dfinity/setup-dfx@e50c04f104ee4285ec010f10609483cf41e4d365
        with:
          dfx-version: "latest"

      - name: 'Confirm dfx installation'
        run: dfx --version

      - name: 'Use free Solana RPC provider'
        working-directory: examples/basic_solana/ninja
        run: |
          perl -pi -e 's|solana_network = opt variant { Devnet }|solana_network = opt variant { Custom = record { url = \\\"https://api.devnet.solana.com\\\"; headers = null } }|g' dfx.json

      - name: 'Install llvm'
        if: matrix.os == 'macos-latest'
        run: |
          brew install llvm

      - name: "Deploy locally and test with dfx"
        working-directory: examples/basic_solana/ninja
        run: |
          dfx start --clean --background
          dfx deploy
          out=$(dfx canister call basic_solana solana_account --output json)
          echo "$out"
          echo "$out" | grep -Eq "[1-9A-HJ-NP-Za-km-z]{32,44}" || { echo "❌ Call to 'solana_account' failed"; exit 1; }
          out=$(dfx canister call basic_solana get_balance --output json)
          echo "$out"
          echo "$out" | grep -Eq "[0-9]+(_[0-9]+)*" || { echo "❌ Call to 'get_balance' failed"; exit 1; }

  basic-solana-local-deployment:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Install icp-cli'
        run: |
          npm install -g @icp-sdk/icp-cli@${ICP_CLI_VERSION} @icp-sdk/ic-wasm@${IC_WASM_VERSION}

      - name: 'Confirm icp-cli installation'
        run: icp --version

      - name: 'Install llvm'
        if: matrix.os == 'macos-latest'
        run: |
          brew install llvm

      - name: 'Install Rust toolchain'
        run: rustup show

      - name: 'Install idl2json'
        uses: taiki-e/install-action@v2
        with:
          tool: idl2json_cli

      - name: "Deploy locally and test with icp-cli"
        working-directory: examples/basic_solana
        run: |
          icp network start --background
          icp deploy --environment local
          icp identity new --storage plaintext caller
          icp identity default caller
          out=$(icp canister call basic_solana solana_account '(null)' | idl2json)
          echo "$out"
          echo "$out" | grep -Eq "[1-9A-HJ-NP-Za-km-z]{32,44}" || { echo "❌ Call to 'solana_account' failed"; exit 1; }
          out=$(icp canister call basic_solana get_balance '(null)' | idl2json)
          echo "$out"
          echo "$out" | grep -Eq "[0-9]+(_[0-9]+)*" || { echo "❌ Call to 'get_balance' failed"; exit 1; }

  check-canister-wasm-endpoints:
    needs: [ reproducible-build ]
    runs-on: ubuntu-22.04
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Download artifacts'
        uses: actions/download-artifact@v4
        with:
          name: sol_rpc_canister.wasm.gz

      - name: 'Install `ic-wasm`'
        uses: taiki-e/install-action@v2
        with:
          tool: ic-wasm

      - name: 'Check canister endpoints'
        run: |
          ic-wasm "$GITHUB_WORKSPACE/sol_rpc_canister.wasm.gz" check-endpoints --hidden ./canister/hidden_endpoints.conf

  integration-tests:
    needs: [ reproducible-build ]
    runs-on: ubuntu-22.04
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Download artifacts'
        uses: actions/download-artifact@v4
        with:
          name: sol_rpc_canister.wasm.gz

      - name: 'Set SOL_RPC_CANISTER_WASM_PATH for load_wasm'
        run: |
          echo "SOL_RPC_CANISTER_WASM_PATH=$GITHUB_WORKSPACE/sol_rpc_canister.wasm.gz" >> "$GITHUB_ENV"

      - name: 'Install PocketIC server'
        uses: dfinity/pocketic@main
        with:
          pocket-ic-server-version: ${POCKET_IC_VERSION}

      - name: 'Install Solana CLI'
        run: |
          sh -c "$(curl -sSfL https://release.anza.xyz/v${SOLANA_CLI_VERSION}/install)"
          echo "/home/runner/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        shell: bash

      - name: 'Start Solana test validator'
        run: |
          solana-test-validator &

      - name: 'Download wallet canister'
        run: |
          wget https://github.com/dfinity/sdk/raw/0a82e042adec6f24ba53665312713923bf276a34/src/distributed/wallet.wasm.gz

      - name: 'Set WALLET_WASM_PATH for load_wasm'
        run: |
          echo "WALLET_WASM_PATH=$GITHUB_WORKSPACE/wallet.wasm.gz" >> "$GITHUB_ENV"

      - name: 'Set BASIC_SOLANA_WASM_PATH for load_wasm'
        run: |
          echo "BASIC_SOLANA_WASM_PATH=$GITHUB_WORKSPACE/examples/basic_solana/target/wasm32-unknown-unknown/canister-release/basic_solana.wasm" >> "$GITHUB_ENV"

      - name: 'Test basic_solana'
        working-directory: examples/basic_solana/
        run: |
          cargo build --target wasm32-unknown-unknown --no-default-features --profile canister-release 
          cargo test --locked --package basic_solana

      - name: 'Test sol_rpc_int_tests'
        run: cargo test --locked --package sol_rpc_int_tests -- --test-threads 2 --nocapture

  end-to-end-tests:
    needs: [ reproducible-build ]
    runs-on: ubuntu-22.04
    concurrency:
      group: ci_environment
    env:
      sol_rpc_canister_id: zaylz-mqaaa-aaaar-qaqzq-cai
      wallet_canister_id: zo2gr-xaaaa-aaaar-qaqyq-cai
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Download artifacts'
        uses: actions/download-artifact@v4
        with:
          name: sol_rpc_canister.wasm.gz

      - name: 'Install icp-cli'
        run: |
          npm install -g @icp-sdk/icp-cli@${ICP_CLI_VERSION} @icp-sdk/ic-wasm@${IC_WASM_VERSION}

      - name: 'Confirm icp-cli successful installation'
        run: icp --version

      - name: "Import dfx deploy key"
        env:
          DFX_DEPLOY_KEY: ${{ secrets.DFX_DEPLOY_KEY }}
        run: |
          key_pem=$(mktemp)
          printenv "DFX_DEPLOY_KEY" > "$key_pem"
          icp identity import --storage plaintext --from-pem "$key_pem" ci
          rm "$key_pem"
          icp identity default ci
          icp identity principal

      - name: "Deploy SOL RPC Canister"
        run: |
          icp canister install \
            --network ic \
            --mode upgrade \
            --wasm "$GITHUB_WORKSPACE/sol_rpc_canister.wasm.gz" \
            "${{ env.sol_rpc_canister_id }}"      

      - name: "Run examples"
        working-directory: canister
        run: ../scripts/examples.sh 2>&1 | tee e2e_examples.log

      - name: "Detect inconsistent results"
        working-directory: canister
        run: cat e2e_examples.log | grep -q -e Inconsistent && exit 1 || exit 0

      - name: "Run end-to-end tests"
        env:
          DFX_DEPLOY_KEY: ${{ secrets.DFX_DEPLOY_KEY }}
        run: cargo test --locked --package sol_rpc_e2e_tests -- --test-threads 1 --nocapture
