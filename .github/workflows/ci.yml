name: 'SOL RPC'

on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - v*
    paths-ignore:
      - "README.md"
env:
  CARGO_TERM_COLOR: always
  SOLANA_CLI_VERSION: "2.1.15"
  RUSTFLAGS: "-Dwarnings"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
      - name: 'Check code'
        run: |
          cargo fmt --all -- --check
          cargo clippy --locked --verbose --tests --benches --workspace -- -D clippy::all
          cargo clippy --locked --verbose --target wasm32-unknown-unknown -p sol_rpc_canister -- -D clippy::all

  cargo-doc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Cargo doc
        run: |
          cargo doc --workspace --no-deps
        env:
          RUSTDOCFLAGS: "--deny warnings"

  reproducible-build:
    runs-on: ubuntu-22.04
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
      - name: Docker build
        run: |
          ./scripts/docker-build

      - name: 'Archive Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: sol_rpc_canister.wasm.gz
          path: ./wasms/sol_rpc_canister.wasm.gz
          if-no-files-found: error
          compression-level: 0

      - name: 'Add summary'
        run: |
          hash=`sha256sum ./wasms/sol_rpc_canister.wasm.gz`
          echo "SHA-256 :hash: ${hash}" >> $GITHUB_STEP_SUMMARY

  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
      - name: 'Run unit tests'
        run: cargo test --locked --workspace --exclude sol_rpc_int_tests

  integration-tests:
    needs: [ reproducible-build ]
    runs-on: ubuntu-22.04
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Download Artifacts'
        uses: actions/download-artifact@v4
        with:
          name: sol_rpc_canister.wasm.gz

      - name: 'Set SOL_RPC_CANISTER_WASM_PATH for load_wasm'
        run: |
          echo "SOL_RPC_CANISTER_WASM_PATH=$GITHUB_WORKSPACE/sol_rpc_canister.wasm.gz" >> "$GITHUB_ENV"

      - name: 'Install PocketIC server'
        uses: dfinity/pocketic@main
        with:
          pocket-ic-server-version: "8.0.0"

      - name: 'Install Solana CLI'
        run: |
          sh -c "$(curl -sSfL https://release.anza.xyz/v${SOLANA_CLI_VERSION}/install)"
          echo "/home/runner/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        shell: bash

      - name: 'Start Solana test validator'
        run: |
          solana-test-validator &

      - name: 'Download wallet canister'
        run: |
          wget https://github.com/dfinity/sdk/raw/0a82e042adec6f24ba53665312713923bf276a34/src/distributed/wallet.wasm.gz

      - name: 'Set WALLET_WASM_PATH for load_wasm'
        run: |
          echo "WALLET_WASM_PATH=$GITHUB_WORKSPACE/wallet.wasm.gz" >> "$GITHUB_ENV"

      - name: 'Cargo test'
        run: cargo test --package sol_rpc_int_tests -- --test-threads 2 --nocapture
